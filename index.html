<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexudus Internal Update Tool</title>
    <link rel="icon" href="https://nexudusacademy.spaces.nexudus.com//images/Favicon.jpg">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Poppins:wght@400;600&display=swap');
        
        body { 
            font-family: 'Poppins', sans-serif; 
            padding: 20px; 
            background-color: #f8f8f8; 
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background-color: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); 
        }
        h1, h3 { 
            font-family: 'Playfair Display', serif;
            font-weight: 600;
            color: #001279; 
        }
        h1 { font-size: 2rem; margin-bottom: 0.5rem; }
        h3 { font-size: 1.25rem; margin-top: 2rem; margin-bottom: 0.75rem; }
        p { color: #4b5563; line-height: 1.5; }
        .warning-text {
            color: #732031;
            font-weight: 600;
            font-style: italic;
            margin-bottom: 20px;
        }
        input[type="text"], input[type="password"], select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            margin-bottom: 15px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-sizing: border-box;
            transition: all 0.2s ease;
        }
        input[type="text"]:focus, input[type="password"]:focus, select:focus {
            outline: none;
            border-color: #001279;
            box-shadow: 0 0 0 3px #16289B;
        }
        input[type="file"] {
            display: block;
            margin-top: 10px;
        }
        button {
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.2s ease;
        }
        #startButton {
            background-color: #FF5100;
        }
        #startButton:hover {
            background-color: #BF3700;
        }
        #downloadButton {
            display: none; /* Initially hidden */
            margin-top: 15px;
            background-color: #001279;
        }
        #downloadButton:hover {
            background-color: #16289B;
        }
        #stopButton {
            display: none;
            margin-left: 10px;
            background-color: #BF3700;
        }
        #stopButton:hover {
            background-color: #FF5100;
        }
        #log {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            height: 300px;
            overflow-y: scroll;
            margin-top: 20px;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #374151;
        }
        .log-success { color: #10b981; }
        .log-error { color: #940a0a; }
        .log-info { color: #001279; }
        .logo-container {
            text-align: center;
            margin-bottom: 20px;
        }
        .logo {
            max-width: 250px;
            height: auto;
        }
        .collapsible-content {
            display: none;
            padding: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background-color: #f9fafb;
            margin-top: 10px;
        }
        #toggleGuideButton {
            background-color: #4b5563;
            color: white;
        }
        #toggleGuideButton:hover {
            background-color: #374151;
        }
        #customEndpointInput {
            display: none;
        }
        .endpoint-text {
            color: #6b7280;
            font-size: 0.875rem;
        }
        .light-text {
            color: #a0a0a0;
        }
        #progressBarContainer {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 8px;
            margin-top: 10px;
            overflow: hidden;
            height: 20px;
        }
        #progressBar {
            height: 100%;
            width: 0;
            background-color: #FF5100;
            transition: width 0.3s ease;
            text-align: center;
            color: white;
            line-height: 20px;
        }
        .status-message {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #4b5563;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="logo-container">
            <img src="https://nexudusacademy.spaces.nexudus.com//images/Logo.png?cache=2025-08-08T11:13:58+04:00" alt="Nexudus Logo" class="logo">
        </div>
        <h1>Nexudus Internal Update Tool</h1>
        <p class="warning-text"><i>Please only use this tool if you're confident in doing so. Making changes without full confidence can cause irreversible changes.</i></p>

        <p>This tool reads a CSV file, iterates through each row, and sends a custom API request. Failed updates will be logged and can be exported to a new file at the end.</p>

        <!-- Guide Section -->
        <button id="toggleGuideButton" onclick="toggleGuide()">Show Guide</button>
        <div id="updateGuide" class="collapsible-content">
            <h4>How to Use This Tool:</h4>
            <p>This tool can currently be used for Updating and Creating records.</p>
            <br>
            <h5>Update:</h5>
            <ol>
                <li><b>Export the existing records:</b> From the Nexudus Admin Panel, export the current records. This file is crucial because it contains the <b>`Id`</b> field, which tells the tool exactly which records to update.</li>
                <li><b>Prepare your file:</b> Clean the export file by removing any columns you will not be updating. You only need to keep the `Id` and the columns with the new data.</li>
                <li><b>Add updated data:</b> Add the column headers for the fields you want to change. For example, if you need to update the `BillingDay` for a list of Contracts, your CSV should include a `BillingDay` column. You can find all possible column headers in the Nexudus API documentation at `developers.nexudus.com`.</li>
                <li><b>Format data correctly:</b>
                    <ul>
                        <li><b>Lists of items</b> will be correctly processed as a JSON array, but only if they are separated by a <b>semicolon (;)</b>. Do not use a comma to separate lists! For example, `Desks: Desk1;Desk2`.</li>
                        <li><b>Dates</b> should be formatted in UTC as `yyyy-mm-dd hh:mm`. The tool will handle the conversion to the correct API format.</li>
                    </ul>
                </li>
            </ol>
            <br>
            <h5>Create:</h5>
            <p>The process for creating new records is the same as above, but you <b>do not need to include the `Id`</b> in your CSV. Ensure all other required fields are completed.</p>
        </div>

        <!-- Authentication Section -->
        <h3>1. Authentication</h3>
        <p>Enter your username and password for the Nexudus account you are creating or updating records for. This information is not stored.</p>
        <div>
            <label for="username" class="font-medium text-gray-700">Username:</label>
            <input type="text" id="username">
        </div>
        <div>
            <label for="password" class="font-medium text-gray-700">Password:</label>
            <input type="password" id="password">
        </div>

        <!-- API Configuration Section -->
        <h3>2. API Configuration</h3>
        <p>Specify the API endpoint and the HTTP method to use for the requests. For PUT requests, the tool will automatically detect array fields from a sample record.</p>
        <div>
            <label for="recordType" class="font-medium text-gray-700">Record Type:</label>
            <select id="recordType" onchange="handleRecordTypeChange()">
                <option value="">-- Select a record type --</option>
                <option value="https://spaces.nexudus.com/api/spaces/bookings">Bookings</option>
                <option value="https://spaces.nexudus.com/api/spaces/bookingproducts">Booking Products</option>
                <option value="https://spaces.nexudus.com/api/spaces/bookingvisitors">Booking Visitors</option>
                <option value="https://spaces.nexudus.com/api/billing/contractcontacts">Contract Contact - Virtual Offices</option>
                <option value="https://spaces.nexudus.com/api/billing/contractdeposits">Contract Deposit</option>
                <option value="https://spaces.nexudus.com/api/billing/contractproducts">Contract Products</option>
                <option value="https://spaces.nexudus.com/api/billing/contractschedules">Contract Schedules</option>
                <option value="https://spaces.nexudus.com/api/billing/coworkercontracts">Contracts</option>
                <option value="https://spaces.nexudus.com/api/billing/coworkerdiscountcodes">Customer Discount Code</option>
                <option value="https://spaces.nexudus.com/api/spaces/coworkerdatafiles">Customer Documents</option>
                <option value="https://spaces.nexudus.com/api/spaces/coworkernotes">Customer Note</option>
                <option value="https://spaces.nexudus.com/api/billing/coworkerproducts">Customer Product Sale</option>
                <option value="https://spaces.nexudus.com/api/spaces/coworkers">Customers</option>
                <option value="https://spaces.nexudus.com/api/spaces/coworkerdeliveries">Deliveries</option>
                <option value="https://spaces.nexudus.com/api/content/calendarevents">Events</option>
                <option value="https://spaces.nexudus.com/api/sys/floorplandesks">Floor Plan Desk/Office</option>
                <option value="https://spaces.nexudus.com/api/crm/cannedresponses">Message Macros</option>
                <option value="https://spaces.nexudus.com/api/billing/timepasses">Pass</option>
                <option value="https://spaces.nexudus.com/api/billing/tariffs">Plan</option>
                <option value="https://spaces.nexudus.com/api/billing/products">Product</option>
                <option value="https://spaces.nexudus.com/api/spaces/resources">Resource</option>
                <option value="custom">None of these? Enter a custom API endpoint URL</option>
            </select>
        </div>
        <div id="customEndpointInput" style="display: none;">
            <label for="apiEndpoint" class="font-medium text-gray-700">Custom API Endpoint URL:</label>
            <input type="text" id="apiEndpoint" placeholder="e.g., https://spaces.nexudus.com/api/custom">
        </div>
        <div id="selectedEndpointDisplay">
            <span class="endpoint-text">Selected Endpoint: </span><span class="endpoint-text" id="selectedEndpointValue"></span>
        </div>
        <div>
            <label for="httpMethod" class="font-medium text-gray-700">HTTP Method:</label>
            <select id="httpMethod">
                <option value="PUT">Update Records <span class="light-text">(PUT)</span></option>
                <option value="POST">Create Records <span class="light-text">(POST)</span></option>
            </select>
        </div>
        
        <!-- File Upload and Action Section -->
        <h3>3. Upload CSV & Run</h3>
        <p>Upload the CSV file. The tool will use the 'Id' column to identify the record and all other columns to form the update payload.</p>
        <input type="file" id="csvFile" accept=".csv">
        <br><br>
        <button id="startButton" onclick="startUpdate()">Start Update</button>
        <button id="stopButton" onclick="stopProcessing()">Stop Processing</button>
        <button id="downloadButton" onclick="downloadFailedRecords()">Download Failed Records</button>

        <!-- Progress Log Section -->
        <h3>4. Progress Log</h3>
        <div id="progressBarContainer">
            <div id="progressBar"></div>
        </div>
        <p class="status-message" id="progressStatus">Ready to begin.</p>
        <pre id="log"></pre>
    </div>

    <script>
        // Array to store failed records
        let failedRecords = [];
        let allRecords = [];
        const requestDelay = 1100; // 1.1 seconds delay between requests to respect rate limits
        let isProcessing = false;
        let arrayFields = []; // Dynamically discovered array fields
        let currentEndpoint = '';
        let processedCount = 0;
        let authHeader = '';
        // List of fields that are expected to be dates
        const dateFields = [
            'StartDate', 'RenewalDate', 'InvoicedPeriod', 'CancellationDate', 
            'PricePlanTermsAcceptedOn', 'UpdatedOn', 'CreatedOn'
        ];

        // Helper functions
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const logEntry = document.createElement('span');
            logEntry.textContent = `${new Date().toLocaleTimeString()} - ${message}\n`;
            
            if (type === 'success') {
                logEntry.className = 'log-success';
            } else if (type === 'error') {
                logEntry.className = 'log-error';
            } else {
                logEntry.className = 'log-info';
            }
            
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function handleRecordTypeChange() {
            const selectElement = document.getElementById('recordType');
            const customInputDiv = document.getElementById('customEndpointInput');
            const selectedEndpointValueSpan = document.getElementById('selectedEndpointValue');
            
            if (selectElement.value === 'custom') {
                customInputDiv.style.display = 'block';
                currentEndpoint = '';
                selectedEndpointValueSpan.textContent = 'Custom';
            } else {
                customInputDiv.style.display = 'none';
                currentEndpoint = selectElement.value;
                selectedEndpointValueSpan.textContent = currentEndpoint;
            }
        }

        function toggleGuide() {
            const guide = document.getElementById('updateGuide');
            const button = document.getElementById('toggleGuideButton');
            if (guide.style.display === 'block') {
                guide.style.display = 'none';
                button.textContent = 'Show Guide';
            } else {
                guide.style.display = 'block';
                button.textContent = 'Hide Guide';
            }
        }

        function stopProcessing() {
            isProcessing = false;
            log('Processing stopped by user.');
            document.getElementById('startButton').disabled = false;
            document.getElementById('stopButton').style.display = 'none';
        }

        function updateProgressBar(count, total) {
            const progressBar = document.getElementById('progressBar');
            const progressStatus = document.getElementById('progressStatus');
            const percentage = (count / total) * 100;
            progressBar.style.width = `${percentage}%`;
            progressStatus.textContent = `Progress: ${count} of ${total} records processed.`;
        }
        
        async function getRecordData(endpoint, id, authHeader) {
            try {
                const getEndpoint = `${endpoint}/${id}`;
                const response = await fetch(getEndpoint, {
                    method: 'GET',
                    headers: { 'Authorization': authHeader }
                });
                if (response.ok) {
                    return await response.json();
                } else {
                    return null;
                }
            } catch (error) {
                return null;
            }
        }

        async function getRecordDataAndDiscoverArrays(endpoint, id, authHeader) {
            try {
                const getEndpoint = `${endpoint}/${id}`;
                const response = await fetch(getEndpoint, {
                    method: 'GET',
                    headers: { 'Authorization': authHeader }
                });
                if (response.ok) {
                    const record = await response.json();
                    
                    for (const key in record) {
                        if (Array.isArray(record[key])) {
                            arrayFields.push(key);
                        }
                    }
                    return record;
                } else {
                    return null;
                }
            } catch (error) {
                return null;
            }
        }

        function mergePayloads(basePayload, updatePayload) {
            return { ...basePayload, ...updatePayload };
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) return { headers: [], records: [] };
            const headers = lines[0].split(',').map(header => header.trim());
            const records = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                const values = line.split(',').map(value => value.trim());
                const record = {};
                for (let j = 0; j < headers.length; j++) {
                    record[headers[j]] = values[j] || null;
                }
                records.push(record);
            }
            return { headers, records };
        }

        function createPayload(record, method) {
            const payload = {};
            for (const key in record) {
                if (method === 'POST' && key === 'Id') continue;
                if (record[key] !== null && record[key] !== '') {
                    const value = record[key];

                    if (dateFields.includes(key)) {
                        payload[key] = convertToIsoDate(value);
                    } else if (arrayFields.includes(key)) {
                        payload[key] = value.includes(';') ? value.split(';') : [value];
                    } else if (!isNaN(value) && value.trim() !== '') {
                        payload[key] = parseFloat(value);
                    } else if (value.toLowerCase() === 'true' || value.toLowerCase() === 'false') {
                        payload[key] = value.toLowerCase() === 'true';
                    } else {
                        payload[key] = value;
                    }
                }
            }
            return payload;
        }
        
        // Helper function to convert human-readable date format to ISO 8601
        function convertToIsoDate(dateString) {
            // Check for a simple YYYY-MM-DD or YYYY-MM-DD HH:mm format
            const match = dateString.match(/^(\d{4}-\d{2}-\d{2})(?: (\d{2}:\d{2}))?$/);
            if (match) {
                const datePart = match[1];
                const timePart = match[2] || '00:00';
                return `${datePart}T${timePart}:00Z`;
            }
            // If the format is already ISO 8601 or another valid format, return it as-is
            return dateString;
        }

        function downloadFailedRecords() {
            if (failedRecords.length === 0) return;
            const allHeaders = Object.keys(failedRecords[0]);
            const csvRows = [allHeaders.join(',')];
            for (const record of failedRecords) {
                const row = allHeaders.map(header => {
                    const value = record[header] || '';
                    return `"${String(value).replace(/"/g, '""')}"`;
                });
                csvRows.push(row.join(','));
            }
            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'failed_api_updates.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // The main functions
        async function startUpdate() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const recordTypeSelect = document.getElementById('recordType');
            const csvFile = document.getElementById('csvFile').files[0];
            const startButton = document.getElementById('startButton');
            const stopButton = document.getElementById('stopButton');
            
            const apiEndpoint = recordTypeSelect.value === 'custom' ? document.getElementById('apiEndpoint').value : recordTypeSelect.value;
            const httpMethod = document.getElementById('httpMethod').value;
            
            if (!username || !password) {
                log('Error: Please enter your username and password.', 'error');
                return;
            }
            if (!apiEndpoint) {
                log('Error: Please enter an API Endpoint URL.', 'error');
                return;
            }
            if (!csvFile) {
                log('Error: Please upload a CSV file.', 'error');
                return;
            }

            log('Processing started...', 'info');
            startButton.disabled = true;
            stopButton.style.display = 'inline-block';
            isProcessing = true;
            authHeader = 'Basic ' + btoa(username + ':' + password);
            processedCount = 0; // Reset progress counter

            const reader = new FileReader();
            reader.onload = async function(event) {
                const csvText = event.target.result;
                const { records } = parseCSV(csvText);
                allRecords = records;
                
                if (allRecords.length === 0) {
                    log('Error: CSV file is empty or could not be parsed.', 'error');
                    stopProcessing();
                    return;
                }

                if (httpMethod === 'PUT') {
                    // For PUT requests, discover array fields first and then proceed with the batch
                    const recordToDiscover = allRecords[0];
                    if (recordToDiscover && recordToDiscover['Id']) {
                        log(`Performing initial GET request to discover array fields on ID ${recordToDiscover['Id']}...`, 'info');
                        await getRecordDataAndDiscoverArrays(apiEndpoint, recordToDiscover['Id'], authHeader);
                        if (arrayFields.length > 0) {
                            log(`Discovered array fields: ${arrayFields.join(', ')}`, 'info');
                        } else {
                            log('No array fields discovered in the sample record.', 'info');
                        }
                    }
                }
                
                log(`Starting batch process for ${allRecords.length} records.`, 'info');
                await processRecords(allRecords);
                endProcessing();
            };
            reader.readAsText(csvFile);
        }

        async function processRecords(recordsToProcess) {
            const apiEndpoint = document.getElementById('recordType').value === 'custom' ? document.getElementById('apiEndpoint').value : document.getElementById('recordType').value;
            const httpMethod = document.getElementById('httpMethod').value;
            const totalRecords = allRecords.length;

            for (const record of recordsToProcess) {
                if (!isProcessing) break;
                
                const recordId = record['Id'];
                let payload = {};

                if (httpMethod === 'PUT') {
                    log(`Fetching existing record for ID ${recordId}...`, 'info');
                    const existingRecord = await getRecordData(apiEndpoint, recordId, authHeader);
                    if (!existingRecord) {
                        const errorMsg = `Could not fetch existing record for ID ${recordId}.`;
                        log(`Error: ${errorMsg}`, 'error');
                        failedRecords.push({ ...record, ErrorMessage: errorMsg });
                        continue;
                    }
                    payload = mergePayloads(existingRecord, createPayload(record, httpMethod));
                } else if (httpMethod === 'POST') {
                    payload = createPayload(record, httpMethod);
                }
                
                const fetchOptions = {
                    method: httpMethod,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authHeader
                    },
                    body: JSON.stringify(payload)
                };

                try {
                    const response = await fetch(apiEndpoint, fetchOptions);
                    if (response.ok) {
                        log(`Success: Record ID ${recordId || 'new record'} processed successfully with method ${httpMethod}.`, 'success');
                    } else {
                        const errorText = await response.text();
                        log(`Error: Failed to process Record ID ${recordId || 'new record'} with method ${httpMethod}. Status: ${response.status}. Message: ${errorText}`, 'error');
                        failedRecords.push({ ...record, ErrorMessage: errorText });
                    }
                } catch (error) {
                    const errorMsg = error.message || 'Network error.';
                    log(`Error: Failed to send request for Record ID ${recordId || 'new record'}. Message: ${errorMsg}`, 'error');
                    failedRecords.push({ ...record, ErrorMessage: errorMsg });
                }
                
                processedCount++;
                updateProgressBar(processedCount, totalRecords);

                if (isProcessing) {
                    await new Promise(resolve => setTimeout(resolve, requestDelay));
                }
            }
        }

        function endProcessing() {
            log('Processing complete!', 'info');
            isProcessing = false;
            document.getElementById('startButton').disabled = false;
            document.getElementById('stopButton').style.display = 'none';

            if (failedRecords.length > 0) {
                document.getElementById('downloadButton').style.display = 'block';
                log(`\n${failedRecords.length} record(s) failed to update. Click "Download Failed Records" to get the details.`, 'error');
            }
        }
    </script>
</body>
</html>
